# RenovateBot `packageManager` SHA512 issue repro

This is a minimal repo for a minimal repro of an issue I encountered with Renovate's automated update to the `packageManager` field in a few projects.

## The Issue

If `package.json` contains a direct github dependency on https://github.com/League-of-Foundry-Developers/foundry-vtt-types, and also uses the `packageManager` field to specify an out of date package manager, Renovate throws an error while producing the PR.

The message from Renovate in the PR looks like this:


> ⚠️ Artifact update problem
>
> Renovate failed to update an artifact related to this branch. You probably do not want to merge this PR as-is.
>
> ♻ Renovate will retry this branch, including artifacts, only when one of the following happens:
>
> * any of the package files in this branch needs updating, or
> * the branch becomes conflicted, or
> * you click the rebase/retry checkbox if found above, or
> * you rename this PR's title to start with "rebase!" to trigger it manually
>
> The artifact failure details are included below:
>
> **File name: undefined**
>
> ```
> Command failed: corepack use pnpm@10.13.1
> ```

And the resulting PR looks like this:

```
-   "packageManager": "pnpm@10.12.4+sha512.5ea8b0deed94ed68691c9bad4c955492705c5eeb8a87ef86bc62c74a26b037b08ff9570f108b2e4dbd1dd1a9186fea925e527f141c648e85af45631074680184"

+   "packageManager": "pnpm@10.13.1"
```

Note the missing SHA512. As far as I can see, the hash is optional, but it's indicative that something went wrong.


## Manual Workaround

1. Clone the repo locally
2. Run `corepack use pnpm`

This updates the `packageManager` field to have the right hash and the PR proceeds as normal.


## Steps to reproduce

1. Fork this repro
2. Enable renovate using the renovate.json included
3. Observe that the first PR generated by Renovate is missing the SHA512 and has the "Artifact update warning"
4. Edit `package.json` to remove the GitHub dependency (you can actually remove the the entire `dependencies` block now it's empty.)
5. Ask RenovateBot to "Create/Rebase" the PR
6. When it's completed the rebase, observe that the PR now has the correct SHA512 in the `packageManager` field.


## Current investigation

The error occurs when the project contains a dependency on fvtt-types:

```json
"fvtt-types": "github:League-of-Foundry-Developers/foundry-vtt-types#main"
```

We get this in the Renovate logs:

```
Installing pnpm@10.14.0 in the project...

Packages are hard linked from the content-addressable store to the virtual store.
  Content-addressable store is at: /runner/cache/others/pnpm/store/v10
  Virtual store is at:             node_modules/.pnpm
...1018_9e07cd5b5728c9c3ad548bfdbcdedfd6 npm-install$ npm install
...1018_9e07cd5b5728c9c3ad548bfdbcdedfd6 npm-install: npm warn deprecated intl-messageformat-parser@1.1.0: We've written a new parser that's 6x faster and is backwards compatible. Please use @formatjs/icu-messageformat-parser
...1018_9e07cd5b5728c9c3ad548bfdbcdedfd6 npm-install: npm warn deprecated intl-relativeformat@1.1.0: This package has been deprecated, please see migration guide at 'https://**redacted**@11.5.2
...1018_9e07cd5b5728c9c3ad548bfdbcdedfd6 npm-install: npm notice
...1018_9e07cd5b5728c9c3ad548bfdbcdedfd6 npm-install: npm error A complete log of this run can be found in: /home/ubuntu/.npm/_logs/2025-08-11T12_59_56_416Z-debug-0.log
...1018_9e07cd5b5728c9c3ad548bfdbcdedfd6 npm-install: Failed
 ERR_PNPM_PREPARE_PACKAGE  Failed to prepare git-hosted package fetched from "https://**redacted**@league-of-foundry-developers/foundry-vtt-types@13.346.0 npm-install: `npm install`
Exit status 1

This error happened while installing a direct dependency of /tmp/renovate/repos/github/n3dst4/renovate-packagemanager-sha512-repro
```

Note how it's deferring to `npm install`, which is installing the dependencies with npm, noting a few deprecations, then erroring out. This is the root of the problem.

This seems to be to do with fvtt-types 1. being a git dependency, and 2. having a `prepare` script. It uses it to run `husky`, which is a git hook handler system in JS.

Running the hooks locally works fine.

Using other git deps works fine.

Upgrading pnpm using corepack works fine locally.

It's only when the `npm install` thing is triggered on renovate that smoke is emitted.

I am not investigating any further.


## Example PR

Here's an example of a PR with the issue:

https://github.com/n3dst4/renovate-packagemanager-sha512-repro/pull/3



## Discussion thread

https://github.com/renovatebot/renovate/discussions/36904
